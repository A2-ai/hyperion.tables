---
title: "parameter-tables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{parameter-tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hyperion)
library(hyperion.tables)
#devtools::load_all()
library(gt)
library(flextable)

model_dir <- system.file("extdata", "models", "onecmt", package = "hyperion.tables")
model_run <- "run003"
```


```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual error",
    TRUE ~ "Other"
  ) |>
  set_spec_parameter_names(source = "display") |>
  set_spec_title(paste(model_run, "Parameters"))

mod <- read_model(file.path(model_dir, paste0(model_run, ".mod")))

info <- get_model_parameter_info(
	mod,
  system.file("lookup.toml", package = "hyperion.tables")
)

info <- info |> 
  update_param_info("SIGMA(2,2)", parameterization = "AddErr")

mod_sum <- summary(mod)

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```


# Changing display names with `set_spec_parameter_names()`

```{r}
spec <- spec |> set_spec_parameter_names(source = "display")

info <- info |>
	update_param_info("SIGMA(1,1)", display = "Proportional Error") |>
  update_param_info("SIGMA(2,2)", display = "Additive Error")

mod_sum <- summary(mod)

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```

```{r}
spec <- spec |> set_spec_parameter_names(source = "nonmem")

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```
## Adding descriptions with `add_spec_columns()`
```{r}
spec <- spec |>
  set_spec_parameter_names(source = "display") |>
  add_spec_columns("description")

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```

## Removing columns with `drop_spec_columns()`
```{r}
# Start fresh to demonstrate drop_columns
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual error",
    TRUE ~ "Other"
  ) |>
  set_spec_parameter_names(source = "display") |>
  drop_spec_columns("unit")

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```

```{r}
# Drop multiple columns
spec <- spec |> drop_spec_columns("shrinkage")

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```

# Structural parameters only

```{r}
sp_spec <- TableSpec() |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    TRUE ~ "Other"
  ) |>
  set_spec_filter(kind == "THETA") |>
  drop_spec_columns("shrinkage")

get_parameters(mod) |>
  apply_table_spec(sp_spec, info) |>
  make_parameter_table()
```

# Random Effect Parameters only
```{r}
re_spec <- TableSpec() |>
  set_spec_sections(
    kind == "OMEGA" ~ "Random Effect Parameters",
    kind == "SIGMA" ~ "Residual Error",
    TRUE ~ "Other"
  ) |>
  set_spec_filter(kind != "THETA") |>
  drop_spec_columns("unit")

get_parameters(mod) |>
  apply_table_spec(re_spec, info) |>
  make_parameter_table()
```

# Confidence Interval level
```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual variance",
    TRUE ~ "Other"
  ) |>
  set_spec_ci(level = 0.7) |>
  set_spec_sigfig(3)

mod_sum <- summary(mod)
info <- get_model_parameter_info(mod)

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  make_parameter_table()
```

# Changing summary info shown

```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual variance",
    TRUE ~ "Other"
  ) |>
  set_spec_ci(level = 0.7) |>
  set_spec_sigfig(3) |>
  set_spec_parameter_names(source = "display")

mod_sum <- summary(mod)
info <- get_model_parameter_info(mod, lookup_path = normalizePath("../inst/lookup.toml"))

get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum, show_cond_num = FALSE) |>
  make_parameter_table()
```

```{r}
get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum, show_cond_num = FALSE, show_ofv = FALSE) |>
  make_parameter_table()
```

```{r}
get_parameters(mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum, show_method = FALSE) |>
  make_parameter_table()
```


# Model Comparison

```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual variance",
    TRUE ~ "Other"
  ) |>
  set_spec_sigfig(3) |>
  drop_spec_columns("variability", "shrinkage", "rse") |>
  set_spec_pvalue(scientific = FALSE)

child_sum <- summary(mod)
child_info <- get_model_parameter_info(mod)

parent_mod <- read_model(file.path(model_dir, "run002.mod"))
mod_sum <- summary(parent_mod)
info <- get_model_parameter_info(parent_mod)

get_parameters(parent_mod) |>
  apply_table_spec(spec, info) |>
  add_summary_info(mod_sum) |>
  compare_with(
    get_parameters(mod) |>
      apply_table_spec(spec, child_info) |>
      add_summary_info(child_sum),
    labels = c("run002", "run003")
  ) |>
  make_comparison_table()
```

## Multiple Comparison Table

```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual error",
    TRUE ~ "Other"
  ) |>
  set_spec_sigfig(3) |>
  set_spec_columns("symbol", "estimate", "ci", "rse", "pct_change") |>
  set_spec_hide_empty(FALSE)

mod1 <- read_model(file.path(model_dir, "run002.mod"))
mod_sum1 <- summary(mod1)
info1 <- get_model_parameter_info(mod1)

mod2 <- read_model(file.path(model_dir, "run003.mod"))
mod_sum2 <- summary(mod2)
info2 <- get_model_parameter_info(mod2)

mod3 <- read_model(file.path(model_dir, "run003b1.mod"))
mod_sum3 <- summary(mod3)
info3 <- get_model_parameter_info(mod3)

comp <- get_parameters(mod1) |>
  apply_table_spec(spec, info1) |>
  add_summary_info(mod_sum1) |>
  compare_with(
    get_parameters(mod2) |>
      apply_table_spec(spec, info2) |>
      add_summary_info(mod_sum2),
    labels = c("run002", "run003")
  ) |>
  compare_with(
    get_parameters(mod3) |>
      apply_table_spec(spec, info3) |>
      add_summary_info(mod_sum3),
    labels = c("run003b1")
  )

comp |>
  make_comparison_table()
```

## Structural model comparison

```{r}
spec <- TableSpec() |>
  set_spec_transforms(omega = "cv") |>
  set_spec_sections(
    kind == "THETA" ~ "Structural model parameters",
    kind == "OMEGA" & diagonal ~ "Interindividual variance parameters",
    kind == "OMEGA" & !diagonal ~ "Interindividual covariance parameters",
    kind == "SIGMA" ~ "Residual error",
    TRUE ~ "Other"
  ) |>
  set_spec_sigfig(3) |>
  set_spec_columns("symbol", "fixed", "estimate") |>
  set_spec_title("Structural Model Parameter Comparison")

mod1 <- read_model(file.path(model_dir, "run001.mod"))
mod_sum1 <- summary(mod1)
info1 <- get_model_parameter_info(mod1)

mod2 <- read_model(file.path(model_dir, "run002.mod"))
mod_sum2 <- summary(mod2)
info2 <- get_model_parameter_info(mod2)

mod3 <- read_model(file.path(model_dir, "run003.mod"))
mod_sum3 <- summary(mod3)
info3 <- get_model_parameter_info(mod3)

mod4 <- read_model(file.path(model_dir, "run003b1.mod"))
mod_sum4 <- summary(mod4)
info4 <- get_model_parameter_info(mod4)

comp <- get_parameters(mod1) |>
  apply_table_spec(spec, info1) |>
  add_summary_info(mod_sum1) |>
  compare_with(
    get_parameters(mod2) |>
      apply_table_spec(spec, info2) |>
      add_summary_info(mod_sum2),
    labels = c("run001", "run002")
   ) |>
  compare_with(
    get_parameters(mod3) |>
      apply_table_spec(spec, info3) |>
      add_summary_info(mod_sum3),
    labels = c("run003")
  ) |>
  compare_with(
    get_parameters(mod4) |>
      apply_table_spec(spec, info4) |>
      add_summary_info(mod_sum4),
    labels = c("run004")
  )
comp |> names()
comp |>
  make_comparison_table()
```

# Parameter Info Audit trail

Using just model comments the source is either model file, default, or user supplied

```{r}
info <- get_model_parameter_info(mod)
audit_parameter_info(info)
```
Editing a property by hand:
```{r}
info <- info |> 
	update_param_info(
		"SIGMA(1,1)", 
		display = "Proportional Error", 
		parameterization = "Proportional") |>
  update_param_info(
		"SIGMA(2,2)", 
		display = "Additive Error", 
		parameterization = "AddErr")

audit_parameter_info(info)
```

Adding lookup values updates sources as well

```{r}
info <- apply_lookup(info, normalizePath("../inst/lookup.toml"))

audit_parameter_info(info)
```

```{r}
info
```

# Transformation Reference

The following table shows how CV, RSE, and CI are computed for each transform and parameter type combination.

```{r transformation-reference, echo=FALSE}
# Default formulas
default_rse <- ""
default_ci <- ""
na_val <- "N/A"

# Build the reference table
transform_ref <- data.frame(
  transform = rep(
    c("Identity", "LogNormal", "Logit", "Proportional", "AddErr", "LogAddErr"),
    each = 3
  ),
  parameter = rep(c("Theta", "Omega", "Sigma"), 6),
  cv = c(
    # Identity: all N/A
    na_val, na_val, na_val,
    # LogNormal: Theta N/A, Omega/Sigma have formula
    na_val,
    "$\\sqrt{\\exp(\\text{Est}) - 1}$",
    "$\\sqrt{\\exp(\\text{Est}) - 1}$",
    # Logit: all N/A
    na_val, na_val, na_val,
    # Proportional: Theta N/A, Omega/Sigma have formula
    na_val,
    "$\\sqrt{\\text{Est}}$",
    "$\\sqrt{\\text{Est}}$",
    # AddErr: all N/A
    na_val, na_val, na_val,
    # LogAddErr: Theta has formula, Omega N/A, Sigma has formula
    "$\\sqrt{\\exp(\\text{Est}^2) - 1}$",
    na_val,
    "$\\sqrt{\\exp(\\text{Est}) - 1}$"
  ),
  rse = c(
    # Identity: all default
    default_rse, default_rse, default_rse,
    # LogNormal: Theta special, Omega/Sigma default
    "$\\sqrt{\\exp(\\text{SE}^2) - 1}$",
    default_rse, default_rse,
    # Logit: Theta special, Omega/Sigma default
    "$(1 - \\text{BT}) \\cdot \\text{SE}$",
    default_rse, default_rse,
    # Proportional: all default
    default_rse, default_rse, default_rse,
    # AddErr: all default
    default_rse, default_rse, default_rse,
    # LogAddErr: all default
    default_rse, default_rse, default_rse
  ),
  ci = c(
    # Identity
    default_ci, default_ci, default_ci,
    # LogNormal
    "$\\exp(\\text{Est} \\pm z \\cdot \\text{SE})$",
    "$\\exp(\\text{Est} \\pm z \\cdot \\text{SE})$",
    "$\\exp(\\text{Est} \\pm z \\cdot \\text{SE})$",
    # Logit
    "$\\frac{1}{1 + \\exp(-(\\text{Est} \\pm z \\cdot \\text{SE}))}$",
    "$\\frac{1}{1 + \\exp(-(\\text{Est} \\pm z \\cdot \\text{SE}))}$",
    "$\\frac{1}{1 + \\exp(-(\\text{Est} \\pm z \\cdot \\text{SE}))}$",
    # Proportional
    default_ci, default_ci, default_ci,
    # AddErr
    default_ci, default_ci, default_ci,
    # LogAddErr
    default_ci, default_ci, default_ci
  ),
  stringsAsFactors = FALSE
)

transform_ref |>
  gt::gt(groupname_col = "transform") |>
  gt::cols_label(
    parameter = "Parameter",
    cv = "CV",
    rse = "RSE",
    ci = "CI"
  ) |>
  gt::fmt_markdown() |>
  gt::tab_header(title = "Transformation Formulas") |>
  gt::tab_footnote("Est = THETA(x)/OMEGA(i,j)/SIGMA(i,j) reported in the .ext file") |>
  gt::tab_footnote("BT = back-transformed estimate = 1/(1 + exp(-Est))") |>
  gt::tab_footnote("SE = Standard Error, z = z-score for CI level") |>
  gt::tab_footnote("CV and RSE formulas are multiplied by 100 to express as percentages") |>
  gt::tab_footnote(
    "SE/|Est| unless otherwise noted",
    locations = gt::cells_column_labels(columns = "rse")
  ) |>
  gt::tab_footnote(
    "Est ± z·SE unless otherwise noted",
    locations = gt::cells_column_labels(columns = "ci")
  ) |>
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = list(
      gt::cells_column_labels(dplyr::everything()),
      gt::cells_title(groups = "title"),
      gt::cells_row_groups()
    )
  ) |>
  gt::tab_options(
    row_group.as_column = TRUE # This option makes the group appear as a column
  )
```

# Model Lineage

```{r}
example_tree <- get_model_lineage(model_dir)

example_tree
```

```{r}
spec <- SummarySpec() |>
  set_spec_pvalue(scientific = FALSE)

example_tree |>
  apply_summary_spec(spec) |>
  make_summary_table()
```
